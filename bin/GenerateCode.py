__author__ = 'huqinghua'
# coding=gbk

import string, os, commands, time
import threading
import shutil
from distutils import dir_util
from shutil import make_archive
from ftplib import FTP
import zipfile
import ctypes

from CommonUtil import CommonUtils
import xml.etree.cElementTree as ET

codeTemplate ="""
__author__ = 'generated by py-ui4win'
# coding=gbk
import string, os, time

from PyUI import *
from MsgBox import *
from PyFrameBase import *
import UICommon
from CommonUtil import CommonUtils

class {CLASS_NAME}(PyFrameBase):
    def __init__(self):
        super({CLASS_NAME}, self).__init__()
        self.clsName = self.__class__.__name__
        self.skinFileName = self.__class__.__name__ + '.xml'

    def GetSkinFile(self):
        return self.skinFileName

    def GetWindowClassName(self):
        return self.clsName

    def OnPrepare(self, sendor, wParam, lParam):
{ON_PREPARE}
    def OnNotify(self, sendor, sType, wParam, lParam):
        if sType == DUI_MSGTYPE_CLICK:
{ON_CLICK}
        if sType == DUI_MSGTYPE_ITEMSELECT:
{ON_ITEMSELECT}
"""

MainPyTemplate = """
__author__ = 'generated by py-ui4win'
# coding=gbk
import string, os, time

from PyUI import *
from MsgBox import *
from PyFrameBase import *
import UICommon
from CommonUtil import CommonUtils

class {CLASS_NAME}(PyFrameBase):
    def __init__(self):
        super({CLASS_NAME}, self).__init__()
        self.clsName = self.__class__.__name__
        self.skinFileName = self.__class__.__name__ + '.xml'

    def GetSkinFile(self):
        return self.skinFileName

    def GetWindowClassName(self):
        return self.clsName

    def OnExit(self, sendor, wParam, lParam):
        self.ExitApp()

    def OnPrepare(self, sendor, wParam, lParam):
{ON_PREPARE}
    def OnNotify(self, sendor, sType, wParam, lParam):
        if sType == DUI_MSGTYPE_CLICK:
{ON_CLICK}
        if sType == DUI_MSGTYPE_ITEMSELECT:
{ON_ITEMSELECT}

def PyAppInit():
    CommonUtils.SaveExePath()
    pyFrameObj = PyFrameCreator()
    obj = pyFrameObj.CreateForm(0, 'PyMain', 'MainFrame', 'pyui4win')
    pyFrameObj.Show()
    CPaintManagerUI.MessageLoop()
"""

class GenerateCode():
    def __init__(self):
        self.code = ''

    def GenerateCode(self, skinXmlPath):
        self.skinXmlPath = skinXmlPath
        if not os.path.isfile(skinXmlPath):
            return -2

        # 分析xml皮肤
        tree = ET.ElementTree(file=skinXmlPath)
        prepare_code = ''
        click_code = ''
        itemselect_code = ''
        for ctltag in ['Control', 'Label', 'Button', 'Option', 'Edit', 'RichEdit','Combo','Text','CheckBox', \
                       'Progress', 'Animation', 'Container', 'HorizontalLayout', 'VerticalLayout', 'TabLayout', 'List', \
                       'WebBrowser']:
            for elem in tree.iter(tag=ctltag):
                if elem.attrib.has_key('name'):
                    #print elem.tag, elem.attrib
                    # OnPrepare
                    prepare_code += '        self.%s = self.PyFind%s("%s")'%(elem.attrib['name'], ctltag, elem.attrib['name']) + os.linesep
                    # DUI_MSGTYPE_CLICK
                    if ctltag in ['Button', 'Option', 'CheckBox']:
                        click_code += '            elif sendor == "%s":'%elem.attrib['name'] + os.linesep
                        click_code += '                pass' + os.linesep
                    # DUI_MSGTYPE_ITEMSELECT
                    if ctltag in ['Combo', 'List']:
                        itemselect_code += '            elif sendor == "%s":'%elem.attrib['name'] + os.linesep
                        itemselect_code += '                pass' + os.linesep

        click_code = click_code.replace('elif', 'if', 1)
        itemselect_code = itemselect_code.replace('elif', 'if', 1)

        # 组合代码
        if os.path.basename(skinXmlPath) == 'MainFrame.xml':
            self.saveFile = os.path.dirname(skinXmlPath) + '\\' + 'PyMain.py' # 要保持为PyMain.py文件
            self.codeTemp = MainPyTemplate
        else:
            self.saveFile = skinXmlPath.replace('.xml','.py')
            self.codeTemp = codeTemplate

        self.code = self.codeTemp.format(\
            CLASS_NAME = os.path.basename(skinXmlPath).split('.')[0],\
            ON_PREPARE = prepare_code,\
            ON_CLICK = click_code if click_code != '' else '            pass',\
            ON_ITEMSELECT = itemselect_code if itemselect_code != '' else '            pass'\
        )

        #写py文件
        outfile = open(self.saveFile, 'wb')
        outfile.write(self.code)
        outfile.close()

        #打开文件
        shell32 = ctypes.windll.LoadLibrary("shell32.dll");
        shell32.ShellExecuteA(None,'open', 'notepad',self.saveFile,'',1);
        return 0

def GeneratePythonCode( skinXmlPath):
    return GenerateCode().GenerateCode(skinXmlPath)

if __name__ == '__main__':
    GeneratePythonCode(r'f:\pyui4win\pyui4win\Demo3\skin\MainFrame.xml')